---
title: Sentiment analysis with .NET for Apache Spark and ML.NET tutorial
description: In this tutorial, you learn how to use ML.NET with .NET for Apache Spark for sentiment analysis.
author: mamccrea
ms.author: mamccrea
ms.date: 03/07/2019
ms.topic: tutorial
---

# Tutorial: Sentiment analysis with .NET for Apache Spark and ML.NET

This tutorial teaches you how to perform sentiment analysis of online reviews using ML.NET and .NET for Apache Spark. ML.NET is a free, cross-platform, open-source machine learning framework. You can use ML.NET with .NET for Apache Spark to scale the training and prediction of machine learning algorithms.

In this tutorial, you learn how to:

> [!div class="checklist"]
>
> * Write a .NET for Apache Spark app that performs sentiment analysis.
> * Use the ML.NET model builder in Visual Studio.
> * 

## Prerequisites

If this is your first .NET for Apache Spark application, start with the [Getting Started tutorial](get-started.md) to become familiar with the basics.

This tutorial uses the ML.NET Model Builder (preview), a visual interface available in Visual Studio. If you do not already have Visual Studio, you can [download the Community version of Visual Studio](https://visualstudio.microsoft.com/downloads/) for free.

[Download and install](https://marketplace.visualstudio.com/items?itemName=MLNET.07) ML.NET Model Builder (preview).

## Build your machine learning model

1. Open Visual Studio and create a new C# Console App (.NET Core). Name the project *MLSparkModel*.

1. In **Solution Explorer**, right-click the *MLSparkModel* project. Then select **Add > Machine Learning**.

1. From the ML.NET Model Builder, select the **Sentiment Analysis** scenario tile.

1. On the **Add data** page, upload the *Yelp* reviews data set. 

1. Choose *Sentiment* from the **Columns to Predict** dropdown.

1. On the **Train** page, set the time to train to *60 seconds* and select **Start training**. Notice the status of your training under **Progress**.

1. Once Model Builder is finished training, evaluate the training results. You can type phrases into the text box below **Try your model** and select **Predict** to see the output.

1. Select **Code** and then select **Added Projects** to add the ML model code to the solution.

1. Notice that two projects are added to your solutions: **MLSparkModelML.ConsoleApp** and **MLSparkModelML.Model**.

1. Double-click on your *MLSpark* C# project and notice that the following project reference has been added.

   ```xml
   <ItemGroup>
       <ProjectReference Include="..\MLSparkModelML.Model\MLSparkModelML.Model.csproj" />
   </ItemGroup>
   ```

## Create a console app

1. Right-click on **MLSparkModelML.Console** in Solution Explorer, and select **Manage NuGet Packages**.

1. Search for **Microsoft.Spark** and install the package. **Microsoft.ML** was installed for you by Model Builder.

### Create a SparkSession

1. Open the *Program.cs* file for **MLSparkModelML.ConsoleApp**. This file was auto-generated by Model Builder. Delete the `using` statements, the contents of the Main() method, and section for sample data generation.

1. Add the following additional `using` statements to the top of the *Program.cs*:

   ```csharp
   using System;
   using System.Collections.Generic;
   using Microsoft.ML;
   using Microsoft.ML.Data;
   using Microsoft.Spark.Sql;
   ```

1. Add the following code to your `Main` method to create a new `SparkSession`. The Spark Session is the entry point to programming Spark with the Dataset and DataFrame API.

   ```csharp
   SparkSession spark = SparkSession
        .Builder()
        .AppName(".NET for Apache Spark Sentiment Analysis")
        .GetOrCreate();
   ```

   Calling the *spark* object created above allows you to access Spark and DataFrame functionality throughout your program.

### Create a DataFrame and print to console

Read in the Yelp review data from the *yelp.csv* file as a `DataFrame`. Include `header` and `inferSchema` options.

```csharp
DataFrame df = spark
    .ReadStream()
    .Option("header", true)
    .Option("inferSchema", true)
    .Csv(DATA_FILEPATH);

df.Show();
```

### Register a user-defined function

You can use UDFs, *user-defined functions*, in Spark applications to perform calculations and analysis on your data. In this how-to, you use ML.NET with a UDF to evaluate each review.

Add the following code to your `Main` method to register a UDF called `MLudf`. 

```csharp
spark.Udf()
    .Register<ModelInput, ModelOutput>("MLudf", (text) => ConsumeModel.Predict(text));
```

This UDF takes a Yelp review string as input, and outputs true or false for positive and negative sentiments, respectively. It uses the *ConsumeModel()* method that was created by Model Builder.

### Use Spark SQL to call the UDF

Now that you've read in your data and incorporated ML, use Spark SQL to call the UDF that will run sentiment analysis on each row of your DataFrame. Add the following code to your `Main` method:

```csharp
// Use Spark SQL to call ML.NET UDF
// Display results of sentiment analysis on reviews
df.CreateOrReplaceTempView("Reviews");
DataFrame sqlDf = spark.Sql("SELECT ReviewText, MLudf(ReviewText) FRReviews");
sqlDf.Show();

// Print out first 20 rows of data
// Prevent data getting cut off by setting truncate = 0
sqlDf.Show(20, 0, false);

spark.Stop();
```

## Run your code

You must use `spark-submit` to run your code. Navigate to your app's root folder using the command prompt and run the following commands.

First, clean and publish your app.

```dotnetcli
dotnet clean
dotnet publish
```

Then navigate to your app's publish folder and run the following `spark-submit` command. Remember to update the command with the actual path of your Microsoft Spark jar file.

```dotnetcli
spark-submit --class org.apache.spark.deploy.dotnet.DotnetRunner --master local /path/to/microsoft-spark-<version>.jar MLSparkModel.exe
```

## Get the code

This tutorial uses code from the [Sentiment Analysis with Big Data](https://github.com/dotnet/spark/tree/master/examples/Microsoft.Spark.CSharp.Examples/MachineLearning/Sentiment) example.

## Next steps

Advance to the next article to learn how to do Structured Streaming with .NET for Apache Spark.
> [!div class="nextstepaction"]
> [Tutorial: Structured Streaming with .NET for Apache Spark](streaming.md)
